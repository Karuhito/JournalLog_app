{% extends "base.html" %}
{% load static %}
<link rel="stylesheet" href="css/calendar.css">
{% block title %}ホーム{% endblock %}

{% block content %}
<div class="container">

    <!-- ヘッダー -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
        <h5 class="mb-2 mb-md-0">
            {{ user.username }} さんの記録
        </h5>

        <!-- 表示切替 -->
        <div class="btn-group btn-group-sm">
            <a href="?view=month"
               class="btn {% if view_mode == 'month' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                月表示
            </a>
            <a href="?view=week"
               class="btn {% if view_mode == 'week' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                週表示
            </a>
        </div>
    </div>

    {% if view_mode == "month" %}
    <!-- ======================
         月表示
         ====================== -->

    <!-- 年月セレクタ -->
    <form method="get" class="mb-3">
        <input type="hidden" name="view" value="month">

        <div class="d-flex gap-2">
            <select name="year" class="form-select w-auto"
                    onchange="this.form.submit();">
                {% for y in years %}
                    <option value="{{ y }}" {% if y == year %}selected{% endif %}>
                        {{ y }}年
                    </option>
                {% endfor %}
            </select>

            <select name="month" class="form-select w-auto"
                    onchange="this.form.submit();">
                {% for m in months %}
                    <option value="{{ m }}" {% if m == month %}selected{% endif %}>
                        {{ m }}月
                    </option>
                {% endfor %}
            </select>
        </div>
    </form>

    <!-- カレンダー -->
    <div class="calendar-wrapper">
        <table class="table table-bordered text-center mb-0">
            <thead class="table-light">
                <tr>
                    <th class="weekday-sun">日</th>
                    <th>月</th>
                    <th>火</th>
                    <th>水</th>
                    <th>木</th>
                    <th>金</th>
                    <th class="weekday-sat">土</th>
                </tr>
            </thead>
            <tbody>
                {% for week in cal_data %}
                <tr>
                    {% for d in week %}
                    <td class="
                        calendar-cell
                        {% if d.is_other_month %}other-month{% endif %}
                        {% if d.is_today %}today{% endif %}
                        {% if d.has_journal %}has-journal{% endif %}
                    ">
                        {% if d.is_other_month %}
                            <span class="text-muted">{{ d.day.day }}</span>
                        {% else %}
                            <a href="{{ d.url }}">
                                <span class="calendar-day">
                                    {{ d.day.day }}
                                </span>
                            </a>
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% else %}
    <!-- ======================
         週表示
         ====================== -->

    <!-- 週ナビゲーション -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="?view=week&week_start={{ prev_week | date:'Y-m-d' }}"
           class="btn btn-outline-secondary btn-sm">
            ← 前の週
        </a>

        <div class="text-center small">
            {{ week_start|date:"Y年n月j日" }} 〜
            {{ week_end|date:"n月j日" }}
        </div>

        <a href="?view=week&week_start={{ next_week | date:'Y-m-d' }}"
           class="btn btn-outline-secondary btn-sm">
            次の週 →
        </a>
    </div>

    <!-- 今日に戻る -->
    <div class="text-center mb-3">
        <a href="?view=week"
           class="btn btn-outline-primary btn-sm">
            今週に戻る
        </a>
    </div>

    <!-- 週カレンダー -->
    <div class="row row-cols-2 row-cols-md-4 g-2">
        {% for d in week_data %}
        <div class="col">
            <a href="{{ d.url }}" class="text-decoration-none">
                <div class="
                    card h-100 text-center
                    {% if d.is_today %}border-primary{% endif %}
                    {% if d.has_journal %}bg-light{% endif %}
                ">
                    <div class="card-body p-2">
                        <div class="small text-muted">
                            {{ d.day|date:"D" }}
                        </div>
                        <div class="fw-bold">
                            {{ d.day|date:"j" }}
                        </div>

                        {% if d.has_journal %}
                            <span class="badge bg-success mt-1">
                                記録あり
                            </span>
                        {% endif %}
                    </div>
                </div>
            </a>
        </div>
        {% endfor %}
    </div>

    {% endif %}
</div>
{% endblock %}